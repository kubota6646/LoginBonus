# LoginBonus バージョン 1.4.2 変更点

## リリース日
2026年2月

## 更新内容

### 包括的なバグ修正

このリリースは、コードレビューによって特定された複数の重要なバグを修正する、安定性とデータ整合性に焦点を当てたメンテナンスリリースです。

#### 変更内容

### クリティカル（重大）なバグ修正

1. **SQLiteストレージの接続リーク修正**
   - SqliteStorageに接続検証と再接続ロジックを追加
   - 接続が切断された場合に自動的に再接続するように修正
   - すべてのデータベース操作前に`reconnectIfNeeded()`を呼び出し
   - データベース接続の信頼性が大幅に向上

2. **プラグイン無効化時のデータ損失防止**
   - `onDisable()`メソッドで非同期保存の完了を待機するように修正
   - `CompletableFuture.get()`を使用して最大10秒間保存完了を待機
   - ストレージ接続を閉じる前にデータ保存が確実に完了
   - サーバーシャットダウン時のデータ損失リスクを排除

3. **MySQLテーブル名のSQLインジェクション対策**
   - テーブル名に対するバリデーションを追加
   - 正規表現`^[a-zA-Z0-9_]+$`による検証
   - 無効な文字が含まれる場合はデフォルト値を使用
   - 設定ファイル経由のSQLインジェクション攻撃を防止

### 高優先度のバグ修正

4. **スレッドセーフティの向上**
   - `HashMap`を`ConcurrentHashMap`に変更
   - `loginTimes`, `currentDates`, `cumulativeMinutesMap`など全てのマップを変更
   - 複数スレッドからの同時アクセスによる競合状態を解消
   - データ整合性の問題を防止

5. **NullPointerException対策**
   - `giveReward()`メソッド内の3箇所でnullチェックを追加
   - `cumulativeMinutesMap.get(playerId)`がnullを返す場合に0.0を使用
   - プレイヤーデータが存在しない場合のクラッシュを防止

6. **リソースリーク修正**
   - `saveDefaultMessages()`メソッドでInputStreamとInputStreamReaderをtry-with-resourcesで管理
   - リソースが確実にクローズされるように修正
   - メモリリークのリスクを排除

7. **MySQL再接続エラーハンドリングの改善**
   - `reconnectIfNeeded()`メソッドで再接続失敗時に例外をスロー
   - 接続がnullまたは閉じている場合にSQLExceptionを送出
   - サイレントな接続失敗を防止し、エラー検出を改善

### 中優先度のバグ修正

8. **プレイヤーオンライン状態の検証**
   - `startTrackingForPlayer()`と`startTracking()`にオンラインチェックを追加
   - プレイヤーがログオフした後の操作を防止
   - より堅牢なプレイヤー追跡を実現

9. **メッセージ置換の配列検証**
   - `getMessage()`メソッドで置換配列の長さを検証
   - 奇数長の配列に対する警告メッセージを追加
   - ArrayIndexOutOfBoundsExceptionを防止

10. **日付解析の例外処理**
    - `giveReward()`メソッドでLocalDate.parse()にtry-catchを追加
    - 無効な日付フォーマットに対するエラーハンドリング
    - データ破損時のクラッシュを防止

## バージョン更新
- `plugin.yml`: version 1.4.1 → 1.4.2
- `build.gradle`: version 1.4.1 → 1.4.2

## 互換性

### サポート対象
- **Minecraftバージョン**: 1.12～1.21.11 (api-version: 1.13で幅広いバージョンをサポート)
- **Javaバージョン**: 8以上（Java 8で動作、Java 17でも動作確認済み）
- **Bukkit/Spigot/Paper**: 標準的なBukkit実装と互換
- **連携プラグイン**: Plan (Player Analytics) - オプション

### 以前のバージョンとの互換性
- **データ互換性**: 既存のプレイヤーデータ（YAML/SQLite/MySQL）はそのまま使用可能
- **設定互換性**: 既存の設定ファイル（config.yml、message.yml）の変更は不要
- **コマンド互換性**: すべてのコマンドとパーミッションは変更なし
- **API互換性**: 他のプラグインとのAPI互換性を維持

## アップグレード方法

### 通常のアップグレード
1. サーバーを停止
2. `plugins/` フォルダ内の古い LoginBonus JAR ファイルを削除
3. 新しい LoginBonus-1.4.2.jar を `plugins/` フォルダに配置
4. サーバーを起動

### 重要な注意事項
- プラグインデータ（playerdata.yml、playerdata.db、MySQLデータベース）はバックアップ推奨
- 設定ファイルの変更は不要です
- このバージョンはバグ修正のみで、新機能の追加はありません

## 動作確認済みの機能
- ログイン時間トラッキング
- 報酬システム
- ストリーク機能
- ボスバー表示
- データベース連携（YAML/SQLite/MySQL）
- 全コマンド（/rewardstreak、/rewardreload、etc.）
- 特別報酬システム（個別日数・倍数報酬）
- マルチサーバー同期（MySQL使用時）
- Plan連携（連続ログイン日数とランキング表示）

## 修正された既知の問題

1. SQLite接続が時間経過で切断される問題
2. サーバーシャットダウン時のデータ損失
3. 複数スレッドからのマップアクセスによる競合状態
4. プレイヤーデータが存在しない場合のNPE
5. InputStreamのリソースリーク
6. MySQL再接続のサイレント失敗
7. オフラインプレイヤーへの操作試行
8. 不正な置換配列によるエラー
9. 破損した日付データによるクラッシュ

## セキュリティ
- SQLインジェクション対策を強化（テーブル名のバリデーション）
- リソース管理の改善によるメモリリーク防止
- スレッドセーフティの向上によるデータ整合性の保護
- CodeQLスキャン実施予定
- コードレビュー実施予定

## パフォーマンス
- ConcurrentHashMapの使用により、マルチスレッド環境でのパフォーマンス向上
- 接続プールと再接続ロジックによるデータベース操作の信頼性向上
- リソースリークの修正によるメモリ使用量の最適化

## 前バージョンからの変更点
- バージョン 1.4.0: Plan連携追加、バグ修正
- バージョン 1.4.1: マルチバージョン対応（1.12～1.21.11）、Java 8互換
- バージョン 1.4.2: 包括的なバグ修正（10件の重要なバグを修正）

## 今後の予定
- 機能追加のフィードバック受付中
- バグ報告はGitHub Issuesへ
- さらなる安定性とパフォーマンスの向上

## 貢献者
- バグ修正: 自動コードレビューに基づく包括的な修正
- GitHub Copilot: コード分析とバグ検出支援
